"use strict";angular.module("asbuiltsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","autocomplete","agsserver","leaflet-directive","ngDragDrop","angularFileUpload"]).value("projectConstants",{version:.1,documentBaseUrl:"http://gis.raleighnc.gov/asbuilts/PROJECT_TRACKING/"}).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}).constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest"}).factory("AuthInterceptor",["$rootScope","$q","AUTH_EVENTS",function(a,b,c){return{responseError:function(d){return a.$broadcast({401:c.notAuthenticated,403:c.notAuthorized,419:c.sessionTimeout,440:c.sessionTimeout}[d.status],d),b.reject(d)}}}]).config(["$routeProvider","$httpProvider","USER_ROLES","$locationProvider",function(a,b,c){a.when("/",{redirectTo:"/map"}).when("/addDocument",{templateUrl:"views/addDoc.html",controller:"addDocCtrl",data:{authorizedRoles:[c.admin,c.editor]}}).when("/instructions",{templateUrl:"views/instructions.html"}).when("/stats",{templateUrl:"views/stats.html",controller:"StatsCtrl"}).when("/map",{templateUrl:"views/map.html",controller:"MapCtrl"}).when("/project/:projectid",{templateUrl:"views/project.html",controller:"projectCtrl"}).when("/document/:documentid",{templateUrl:"views/documents.html",controller:"DocCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/error",{templateUrl:"404.html"}).otherwise({redirectTo:"/error"}),b.defaults.useXDomain=!0,delete b.defaults.headers.common["X-Requested-With"],b.interceptors.push(["$injector",function(a){return a.get("AuthInterceptor")}])}]).run(function(a,b,c,d){a.$on("$stateChangeStart",function(e,f,g){var h=f.data.authorizedRoles;c.isAuthorized(h)||(e.preventDefault(),a.$broadcast(c.isAuthenticated()?b.notAuthorized:b.notAuthenticated)),"undefined"!=typeof g&&d.remove(g.templateUrl)})}),angular.module("asbuiltsApp").service("ags",["$resource",function(a){var b="http://:name.raleighnc.gov/arcgis/rest/services/PublicUtility/:folder/:serviceType";this.AgsLayers=function(a){return this.items=a,this},this.AgsLayers.prototype.getLayerId=function(a){for(var b=0,c=this.items.length;c>b;b++)if(this.items[b].name===a)return this.items[b].id},this.paramDefaults={test:{name:"mapstest",folder:"ProjectTracking",serviceType:"FeatureServer"},fs:{name:"mapstest",id:"0",folder:"ProjectTracking",serviceType:"FeatureServer"},addFeature:{name:"mapstest",id:"4",folder:"ProjectTracking",serviceType:"FeatureServer"}},this.ServerActions=function(){this.actions={}},this.ServerActions.prototype={Type:function(a,b,c,d,e){this.method=a||"GET",this.timeout=b||5e3,this.params=c||{},this.cache=d||!1,this.headers=e||{"Content-Type":"application/json"}},setAction:function(a,b,c,d,e,f){var g=new this.Type(b,c,d,e,f);this.actions[a]=g},changeParams:function(a,b){return angular.extends(this.actions[a],b),this}},this.testActions=new this.ServerActions,this.testActions.setAction("getService","GET",5e3,{f:"json"},!0),this.testActions.setAction("getAll","GET",5e3,{f:"json",outFields:"*",where:"OBJECTID > 0",returnGeometry:!1},!0),this.testActions.setAction("delete","POST",5e3,{f:"json"},!1,{"Content-Type":"text/plain"}),this.testActions.setAction("newDocument","POST",5e3,{f:"json"},!1,{"Content-Type":"text/plain"}),this.testActions.setAction("update","POST",5e3,{f:"json"},!1,{"Content-Type":"text/plain"}),this.testServer=a(b,this.paramDefaults.test,this.testActions.actions),this.features=a(b+"/:id/query",this.paramDefaults.fs,this.testActions.actions),this.deleteFeatures=a(b+"/:id/deleteFeatures",this.paramDefaults.addFeature,this.testActions.actions),this.addDocument=a(b+"/:id/addFeatures",this.paramDefaults.addFeature,this.testActions.actions),this.updateDocument=a(b+"/:id/updateFeatures",this.paramDefaults.addFeature,this.testActions.actions),this.addFieldFromTable=function(a,b,c,d){return a.map(function(a){b.forEach(function(b){a.attributes[c]===b.attributes[c]?a.attributes[d]=b.attributes[d]:a})}),a}}]),angular.module("asbuiltsApp").service("CookieService",["$cookieStore",function(a){this.addProjectCookie=function(b){var c=a.get("projects");return void 0!==c&&c.length>0&&-1===c.indexOf(b)?(console.log("Add to Cookie"),c.unshift(b),c.length>5?c.pop():c,a.put("projects",c)):c||(console.log("new cookie"),a.put("projects",[b])),this}}]),angular.module("asbuiltsApp").service("projectSearch",["Ags","serverFactory","OptionsFactory","$filter","$cacheFactory","$rootScope",function(a,b,c,d,e,f){var g=f;g.mapstest=new a({host:"mapstest.raleighnc.gov"}),g.gis=new a({host:"gis.raleighnc.gov"}),g.pt_ms=g.mapstest.setService({folder:"PublicUtility",service:"ProjectTracking",server:"MapServer"}),this.autoFill=function(a){a=a.toUpperCase();var c={layer:"Project Tracking",geojson:!1,actions:"query",params:{f:"json",outFields:"PROJECTNAME,DEVPLANID,PROJECTID",text:a,returnGeometry:!1,orderByFields:"PROJECTNAME ASC"}};return b.pt_ms.request(c)},this.getSet=function(a){if(!a)return[];for(var b=[],c=0,d=a.length;d>c;c++)-1!==b.indexOf(b[c])?a:b.push(a[c]);return b}}]),angular.module("asbuiltsApp").service("StreetSearch",["serverFactory",function(a){this.autoFill=function(b){b=b.toUpperCase();var c={layer:"Streets",geojson:!1,actions:"query",params:{f:"json",outFields:"CARTONAME",text:b,returnGeometry:!1,orderByFields:"CARTONAME ASC"}};return a.streets_ms.request(c)}}]),angular.module("asbuiltsApp").service("Session",function(){return this.create=function(a,b,c){this.id=a,this.userId=b,this.userRole=c},this.destroy=function(){this.id=null,this.userId=null,this.userRole=null},this}),angular.module("asbuiltsApp").factory("AuthService",["$http","Session","$cookieStore","$window",function(a,b,c,d){var e={};return e.login=function(c){return a.post("http://localhost:8000/login",c).then(function(a){return b.create(a.data.id,a.data.user.id,a.data.user.role),d.location.href="http://localhost:9000/#/map",a.data.user},function(a){console.log(a)})},e.isAuthenticated=function(){return!!b.userId},e.isAuthorized=function(a){return angular.isArray(a)||(a=[a]),e.isAuthenticated()&&-1!==a.indexOf(b.userRole)},e}]);var app=angular.module("asbuiltsApp");app.factory("OptionsFactory",[function(){var a=function(a,b,c,d,e){return this.f=a||"json",this.outFields=b||"*",this.where=c||"OBJECTID > 0",this.orderByFields=d||null,this.returnGeometry=e||"false",this};return a.prototype={getOptions:function(){return this},updateOptions:function(a,b){return Object.keys(this).indexOf(a)>-1?this[a]=b:this,this},addOptions:function(a,b){return this[a]=b,this},removeOptions:function(a){return delete this[a],this}},a}]),app.factory("AddFeatureOptionsFactory",[function(){var a=function(a){return this.options={f:a.f||"json",features:a.features||[{atttributes:{}}]},this};return a.prototype={addOptions:function(a){return angular.extend(this.options,a),this},getOptions:function(){return this.options}},a}]),app.factory("DeleteOptionsFactory",[function(){var a=function(a){return this.options={f:a.f||"json",objectIds:a.objectIds||null},this};return a.prototype={deleteOptions:function(a){return angular.extend(this.options,a),this},getOptions:function(){return this.options}},a}]),angular.module("asbuiltsApp").factory("DocumentFactory",["serverFactory","AddFeatureOptionsFactory","DeleteOptionsFactory","$cacheFactory",function(a,b,c,d){function e(a){for(var b in a)void 0===a[b]&&delete a[b],a[b]="false"===a[b]?0:"true"===a[b]?1:a[b];return a}var f=d("docId"),g=function(a){return this.data={PROJECTNAME:a.PROJECTNAME,PROJECTID:a.PROJECTID,DOCID:a.DOCID||0,WATER:a.WATER||0,SEWER:a.SEWER||0,REUSE:a.REUSE||0,STORM:a.STORM||0,FORMERNAME:a.FORMERNAME||void 0,ALIAS:a.ALIAS||void 0,DEVPLANID:a.DEVPLANID,STREET_1:a.STREET_1||void 0,STREET_2:a.STREET_2||void 0,STREET_3:a.STREET_3||void 0,STREET_4:a.STREET_4||void 0,NOTES:a.NOTES||void 0,TAGS:a.TAGS||void 0,ENGID:a.ENGID||void 0,DOCTYPEID:a.DOCTYPEID||void 0,SHEETTYPEID:a.SHEETTYPEID||void 0},this};return g.prototype={setValue:function(a){return angular.extend(this.data,a),this},getData:function(){return this.data},postNewDoc:function(){var b=this,c={};angular.copy(b.data,c),c=e(c);var d={layer:"RPUD.PTK_DOCUMENTS",actions:"addFeatures",params:{f:"json",features:[{attributes:c}]}};a.pt_fs.request(d).then(function(a){a.error?console.log(a.error):(f.put("newId",a.addResults[0].objectId),b.setValue({OBJECTID:a.addResults[0].objectId}),console.log(f.get("newId")))},function(a){console.log(a)})},updateDoc:function(){for(var b in this.data)this.data[b]?this.data:delete this.data[b];console.log("Updated: "+this.data.OBJECTID);var c={layer:"RPUD.PTK_DOCUMENTS",actions:"updateFeatures",params:{f:"json",features:[{attributes:this.data}]}};a.pt_fs.request(c).then(function(a){console.log(a.error?a.error:a)},function(a){console.log(a)})},deleteDoc:function(){console.log("Deleted: "+this.data.objectIds);var b={layer:"RPUD.PTK_DOCUMENTS",actions:"deleteFeatures",params:{f:"json",objectIds:this.data.objectIds}};a.pt_fs.request(b).then(function(a){console.log(a.error?a.error:a)},function(a){console.log(a)})}},g}]),angular.module("asbuiltsApp").factory("IconFactory",[function(){var a=function(a,b,c,d,e,f){return this.name=a,this.message=b,this.icon={iconUrl:c,iconSize:d,iconAnchor:e,popupAnchor:f},this},b=function(){return this.list=[],this};return b.prototype={addIcon:function(b,c,d,e,f,g){this.list.push(new a(b,c,d,e,f,g))}},b}]),angular.module("asbuiltsApp").factory("serverFactory",["Ags",function(a){var b=new a({host:"mapstest.raleighnc.gov"}),c=new a({host:"maps.raleighnc.gov"}),d=new a({host:"maps.raleighnc.gov"}),e={pt_ms:b.setService({folder:"PublicUtility",service:"ProjectTracking",server:"MapServer"}),pt_fs:b.setService({folder:"PublicUtility",service:"ProjectTracking",server:"FeatureServer",header:{"Content-Type":"application/json"}}),streets_ms:c.setService({folder:"StreetsDissolved",service:"",server:"MapServer"}),reclaimed_ms:d.setService({folder:"PublicUtility",service:"ReclaimedDistribution",server:"MapServer"}),water_ms:d.setService({folder:"PublicUtility",service:"WaterDistribution",server:"MapServer"}),sewer_ms:c.setService({folder:"PublicUtility",service:"SewerExternal",server:"MapServer"}),parcels_ms:c.setService({folder:"",service:"Parcels",server:"MapServer"})};return e.addFieldFromTable=function(a,b,c,d){return a.map(function(a){b.forEach(function(b){a.attributes[c]===b.attributes[c]?a.attributes[d]=b.attributes[d]:a})}),a},e}]),angular.module("asbuiltsApp").directive("documentForm",["serverFactory","DocumentFactory","StreetSearch","$timeout","$filter","$http",function(a,b,c,d,e,f){return{restrict:"E",transclude:!0,scope:{project:"="},templateUrl:"views/document-form.html",link:function(e){function g(a){var b={params:{filename:a}};return f.get("http://localhost:8000/upload",b)}e.supportTables=[{name:"engTypes",id:"RPUD.ENGINEERINGFIRM",joinField:"ENGID",addField:"SIMPLIFIEDNAME"},{name:"sheetTypes",id:"RPUD.SHEETTYPES",joinField:"SHEETTYPEID",addField:"SHEETTYPE"},{name:"docTypes",id:"RPUD.DOCUMENTTYPES",joinField:"DOCTYPEID",addField:"DOCUMENTTYPE"}],e.project=void 0,e.refresh=function(b){if(console.log(b),void 0!==b){e.supportTables.forEach(function(c){var d=c.name,f={layer:c.id,actions:"query",params:{f:"json",where:"OBJECTID > 0",outFields:"*",orderByFields:c.addField+" ASC",returnGeometry:!1}};a.pt_fs.request(f).then(function(f){switch(console.log(f),c.data=f.features,a.addFieldFromTable(b,c.data,c.joinField,c.addField),d){case"engTypes":e.engTypes=c.data;break;case"sheetTypes":e.sheetTypes=c.data;break;case"docTypes":e.docTypes=c.data;break;default:console.log("Table not found")}})});var c=["WATER","SEWER","REUSE","STORM"];b.forEach(function(a){a.edit=!1,g(a.attributes.PROJECTID+"-"+a.attributes.DOCTYPEID+"-"+a.attributes.DOCID+".pdf").then(function(b){a.upload=b.data,a.upload.isSuccess=!1},function(a){console.log(a)});for(var b=0,d=c.length;d>b;b++)a.attributes[c[b]]=a.attributes[c[b]]?"true":"false"})}},e.$watchCollection("project",function(){console.log(e.project),e.refresh(e.project)}),e.selectionOptions={bool:[{name:"true",id:1},{name:"false",id:0}]},e.autoFill=function(a){e.streets=[];var b=c.autoFill(a);b.then(function(a){var b;for(var c in a.features)b=a.features[c].attributes.CARTONAME,-1===e.streets.indexOf(b)&&e.streets.length<5&&e.streets.push(b)},function(a){console.log(a)})},e.edit=function(a){e.project.forEach(function(a){a.edit=!1}),a.edit=!0,d(function(){a.edit=!1},6e4)},e.addDoc=!0,e.add=function(){e.newDocument=new b({PROJECTNAME:e.project[0].attributes.PROJECTNAME,PROJECTID:e.project[0].attributes.PROJECTID,DEVPLANID:e.project[0].attributes.DEVPLANID||void 0,DOCID:e.project[e.project.length-1].attributes.DOCID+1||1}),e.newDocument.postNewDoc(),e.newDoc=e.newDocument.getData(),e.project.push({attributes:e.newDoc,edit:!1})},e.post=function(a){e.updateDocument=new b(a).setValue(a),e.updateDocument.updateDoc()},e.delete=function(a,c){e.deleteDocument=new b(c).setValue(c),e.deleteDocument.deleteDoc(),e.project.splice(a,1),angular.element(target)}}}}]),angular.module("asbuiltsApp").directive("pdfCarousel",function(){return{restrict:"E",transclude:!0,scope:{docs:"="},templateUrl:"views/pdf-carousel.html",link:function(a){a.$watchCollection("docs",function(){a.moveFoward=function(){var b=a.docs.shift();a.docs.push(b)},a.moveBackward=function(){var b=a.docs.pop();a.docs.unshift(b)}})}}}),angular.module("asbuiltsApp").directive("projectTable",["Ags","$filter",function(){return{restrict:"E",transclude:!0,scope:{project:"="},templateUrl:"views/project-table.html",link:function(a){var b;a.$watchCollection("project",function(){a.project&&(b="http://devplansarchive.ci.raleigh.nc.us/documents/devplans/"+a.project.DEVPLANID,a.project.CPLINK=b)}),a.popup=function(a){var b=window.open(a,"name","height=500,width=500");return window.focus&&b.focus(),!1}}}}]),angular.module("asbuiltsApp").directive("mapEdit",["serverFactory","$filter","leafletData",function(a,b,c){return{restrict:"E",transclude:!0,scope:{data:"=",active:"="},templateUrl:"views/map-edit.html",link:function(d){function e(a){if(!a instanceof Date){var c=a.split("/"),d=c[2],e=c[0],f=c[1];return new Date(d,e,f)}a?b("date")(a,"yyyy/MM/dd"):console.log(a)}var f=["WATERUPDATEDWHEN","SEWERUPDATEDWHEN","REUSEUPDATEDWHEN","ACCEPTANCEDATE","WARRANTYENDDATE","DEVPLAN_APPROVAL"],g=["CIP","WATER","SEWER","REUSE","STORM"];d.editorList=["kellerj","mazanekm","rickerl","sorrellj","stearnsc","whitec"],d.master={};var h={layer:"Project Tracking",params:{f:"json",gdbVersion:"SDE.DEFAULT",features:[{}]}},i={actions:"query",layer:"Project Tracking",params:{f:"json",outFields:"PROJECTID",orderByFields:"PROJECTID DESC",returnGeometry:!1,where:"PROJECTID IS NOT NULL"}};d.generateProjectId=function(){a.pt_fs.request(i).then(function(a){d.currentMaxProjectId=a.features[0].attributes.PROJECTID,d.newMaxProjectId=d.currentMaxProjectId+1,d.update.PROJECTID=parseInt(d.update.PROJECTID,10)||parseInt(d.newMaxProjectId,10),h.actions=d.update.OBJECTID?"updateFeatures":"addFeatures",d.newProject={geometry:d.data.geometry,attributes:d.update}},function(a){console.log(a)})},d.saveToMaster=function(){angular.copy([d.newProject],h.params.features);var c=h.params.features[0].attributes;for(var e in c)c[e]="string"==typeof c[e]?c[e].toUpperCase():c[e],c[e]="0"===c[e]||c[e]&&-1!==g.indexOf(e)?parseInt(c[e],10):c[e],c[e]=c[e]instanceof Date?b("date")(c[e],"MM/dd/yyyy"):c[e];"addFeatures"===h.actions?$rootScope.pt_fs.request(i).then(function(b){d.newMaxProjectId=b.features[0].attributes.PROJECTID+1,c.PROJECTID=parseInt(d.newMaxProjectId,10),a.pt_fs.request(h).then(function(a){console.log(a)},function(a){console.log(a)})},function(a){console.log(a)}):a.pt_fs.request(h).then(function(a){console.log(a)},function(a){console.log(a)}),d.active=!1},d.reset=function(a){a&&(a.$setPristine(),a.$setUntouched()),d.update=angular.copy(d.master)},d.cancel=function(a){a&&(a.$setPristine(),a.$setUntouched()),d.update=angular.copy(d.master),d.active=!1},d.reset(d.form),c.getMap("mini-map").then(function(a){L.tileLayer("https://{s}.tiles.mapbox.com/v3/examples.3hqcl3di/{z}/{x}/{y}.png").addTo(a)}),d.$watchCollection("active",function(){d.active?angular.element(".angular-leaflet-map").addClass("map-move-left"):angular.element(".angular-leaflet-map").removeClass("map-move-left")}),d.$watchCollection("data",function(){if(d.master={},d.data){d.reset(d.form),angular.extend(d,{geojson:{data:d.data,style:{fillColor:"rgba(253, 165, 13)",weight:3,opacity:1,color:"rgba(253, 165, 13, 0.71)",dashArray:"4"},onEachFeature:function(a,b){c.getMap("mini-map").then(function(a){a.fitBounds(b.getBounds())})}}});for(var b in f)d.data.properties[f[b]]&&(console.log("Date action"),d.data.properties[f[b]]=e(d.data.properties[f[b]]));angular.extend(d.update,d.data.properties),a.pt_fs.request(i).then(function(a){d.currentMaxProjectId=a.features[0].attributes.PROJECTID,d.newMaxProjectId=d.currentMaxProjectId+1,d.update.PROJECTID=parseInt(d.update.PROJECTID,10)||parseInt(d.newMaxProjectId,10),h.actions=d.update.OBJECTID?"updateFeatures":"addFeatures",d.newProject={geometry:Terraformer.ArcGIS.convert(d.data.geometry),attributes:d.update}},function(a){console.log(a)})}})}}}]),angular.module("asbuiltsApp").directive("loginDialog",["AUTH_EVENTS",function(a){return{restrict:"A",template:"view/login-template.html",link:function(b){var c=function(){b.visible=!0};b.visible=!1,b.$on(a.notAuthenticated,c),b.$on(a.sessionTimeout,c)}}}]),angular.module("asbuiltsApp").directive("timer",["$interval",function(a){return{restrict:"E",transclude:!0,templateUrl:"views/timer.html",link:function(b){b.time={hour:0,min:0,sec:0,current:"00:00:00",display:function(){return b.time.hour<10?b.time.hour=0+b.time.hour:b.time.min<10?b.time.min=0+b.time.min:b.time.sec<10&&(b.time.sec=0+b.time.sec),b.time.hour+":"+b.time.min+":"+b.time.sec}},b.start=function(){a(function(){b.time.sec<60?b.time.sec++:60===b.time.sec?(b.time.min++,b.time.sec=0):60===b.time.min&&(b.time.hour++,b.time.min=0),b.time.current=b.time.display()},1e3)},b.stop=function(){},b.reset=function(){}}}}]),angular.module("asbuiltsApp").controller("LoginCtrl",["$scope","$rootScope","AUTH_EVENTS","AuthService",function(a,b,c,d){a.credentials={username:"",password:""},a.login=function(e){d.login(e).then(function(d){b.$broadcast(c.loginSuccess),console.log(b),a.setCurrentUser(d)},function(){b.$broadcast(c.loginFailed)})}}]),angular.module("asbuiltsApp").controller("ApplicationController",["$scope","USER_ROLES","AuthService",function(a,b,c){a.currentUser=null,a.userRoles=b,a.isAuthorized=c.isAuthorized,a.setCurrentUser=function(b){a.currentUser=b}}]),angular.module("asbuiltsApp").controller("HeaderController",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]),angular.module("asbuiltsApp").controller("StatsCtrl",["$scope","$http","$timeout","OptionsFactory","ags",function(a,b,c,d,e){e.testServer.getService().$promise.then(function(b){a.layers=new e.Layers(b.layers.concat(b.tables));var c=new OptionsFactory("json","*","DEVPLANID = 'GH-5-2011'","PROJECTNAME ASC","true");c.addOptions("id",a.layers.getLayerId("Project Tracking"));var d=e.features.getAll(c);console.log(d)})}]),angular.module("asbuiltsApp").controller("RecentCtrl",["$scope","$cookieStore","$rootScope",function(a,b,c){a.recent=b.get("projects"),a.$watchCollection("myrecent",function(){a.recent=b.get("projects")})}]),angular.module("asbuiltsApp").controller("MapCtrl",["$scope","$http","$filter","$sce","leafletData","projectSearch","projectConstants","$rootScope","CookieService","serverFactory",function(a,b,c,d,e,f,g,h,i,j){function k(a,b){var c="<ul>";for(var d in a.properties)"Null"!==a.properties[d]&&""!==a.properties[d]?c+="<li><i>"+d+"</i>: "+a.properties[d]+"</li>":c;c+="</ul>",b.bindPopup(c,{maxHeight:300})}function l(a){for(var b in a)null!==a[b]?a[b]:delete a[b]}a.searchStatus=!1,angular.extend(a,{center:{lat:35.77882840327371,lng:-78.63945007324219,zoom:13},layers:{baselayers:{xyz:{name:"Death Star",url:"https://{s}.tiles.mapbox.com/v3/examples.3hqcl3di/{z}/{x}/{y}.png",type:"xyz"},darkRaleigh:{name:"Raleigh - Dark",url:"https://{s}.tiles.mapbox.com/v3/ctwhite.l4hma6jb/{z}/{x}/{y}.png",type:"xyz"},osm:{name:"Open Street Map",url:"http://{s}.tile.osm.org/{z}/{x}/{y}.png",type:"xyz"},esriImagery:{name:"esri Imagery",type:"dynamic",url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",visible:!1,layerOptions:{layers:[0,1,2,3],opacity:1,attribution:"Copyright:© 2014 Esri, DeLorme, HERE, TomTom"}},raleigh:{name:"Basic Base Map",type:"dynamic",url:"http://maps.raleighnc.gov/arcgis/rest/services/BaseMap/MapServer",visible:!1,layerOptions:{layers:["*"],opacity:.5,attribution:"Copyright:© 2014 City of Raleigh"}}},overlays:{projects:{name:"Project Tracking",type:"dynamic",url:"http://mapstest.raleighnc.gov/arcgis/rest/services/PublicUtility/ProjectTracking/MapServer",visible:!1,layerOptions:{layers:[2],opacity:.5,attribution:"Copyright:© 2014 City of Raleigh"}},sewer:{name:"Sewer Collection Network",type:"dynamic",url:"http://maps.raleighnc.gov/arcgis/rest/services/PublicUtility/SewerExternal/MapServer",visible:!1,layerOptions:{layers:[0,1,2,3,4],opacity:1,attribution:"Copyright:© 2014 City of Raleigh"}},water:{name:"Water Distribution Network",type:"dynamic",url:"http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/WaterDistribution/MapServer",visible:!1,layerOptions:{layers:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],opacity:1,attribution:"Copyright:© 2014 City of Raleigh"}},reuse:{name:"Reuse Distribution Network",type:"dynamic",url:"http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/ReclaimedDistribution/MapServer",visible:!1,layerOptions:{layers:[0,1,2,3,4,5,6,7,8,9,10,11],opacity:1,attribution:"Copyright:© 2014 City of Raleigh"}},detailsIntersections:{name:"Detailed Intersections",type:"dynamic",url:"http://mapstest.raleighnc.gov/arcgis/rest/services/PublicUtility/ProjectTracking/MapServer/",visible:!1,layerOptions:{layers:[0],opacity:1,attribution:"Copyright:© 2014 City of Raleigh"}},parcels:{name:"Parcels",type:"dynamic",url:"http://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer",visible:!1,layerOptions:{layers:["*"],opacity:1,attribution:"Copyright:© 2014 City of Raleigh"}}}}});var m=new L.FeatureGroup,n={edit:{featureGroup:m},draw:{polygon:{shapeOptions:{color:"blue"},repeatMode:!1,allowIntersection:!1},marker:!1,circle:!1,polyline:!1,rectangle:!1}},o=new L.Control.Draw(n);angular.extend(a,{controls:{custom:[o]}});var p,q=new L.FeatureGroup,r={fill:!1,weight:5,opacity:1,color:"rgba(12, 235, 255, 0.71)",dashArray:"4"};e.getMap("map").then(function(b){b.on("click",function(a){q.clearLayers(),b.eachLayer(function(c){if(void 0!==c.options&&c.options.layers){var d={params:{f:"json",geometry:{x:a.latlng.lng,y:a.latlng.lat},mapExtent:[a.latlng.lng,a.latlng.lat,a.latlng.lng+.01,a.latlng.lat+.01].toString(),tolerance:2,imageDisplay:"600, 550, 96",layers:c.options.layers.toString(),sr:4326},actions:"identify",geojson:!0};switch(c.url){case"http://mapstest.raleighnc.gov/arcgis/rest/services/PublicUtility/ProjectTracking/MapServer/":j.pt_ms.request(d).then(function(a){p=L.geoJson(a,{onEachFeature:k,style:r}),q.addLayer(p)});break;case"http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/ReclaimedDistribution/MapServer/":j.reclaimed_ms.request(d).then(function(a){p=L.geoJson(a,{onEachFeature:k,style:r}),q.addLayer(p)});break;case"http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/WaterDistribution/MapServer/":j.water_ms.request(d).then(function(a){p=L.geoJson(a,{onEachFeature:k,style:r}),q.addLayer(p)});break;case"http://maps.raleighnc.gov/arcgis/rest/services/PublicUtility/SewerExternal/MapServer/":j.sewer_ms.request(d).then(function(a){p=L.geoJson(a,{onEachFeature:k,style:r}),q.addLayer(p)});break;case"http://maps.raleighnc.gov/arcgis/rest/services/Parcels/MapServer/":j.parcels_ms.request(d).then(function(a){p=L.geoJson(a,{onEachFeature:k,style:r}),q.addLayer(p)});break;default:return}q.addTo(b),q.bringToFront()}})}),b.on("draw:drawstart",function(){a.project_docs=!1,a.searchStatus=!1,angular.element(".angular-leaflet-map").removeClass("map-move"),angular.element(".map-edit-container").removeClass("map-edit-container-move"),m.clearLayers()}),b.on("draw:created",function(c){var d=c.layer;a.active=!0,a.editLayer=d.toGeoJSON(),m.addLayer(d),m.addTo(b)}),b.on("draw:edited",function(b){console.log("draw:edited");var c=b.layers;c.eachLayer(function(b){console.log(b),a.editLayer=b.toGeoJSON()})}),b.on("draw:editstart",function(b){var c=b.target;console.log("editstart"),console.log(c),c.eachLayer(function(b){console.log(b),b.feature&&(a.editLayer=b.toGeoJSON())}),a.active=!0,a.searchStatus=!1}),b.on("draw:editstop",function(a){a.layers;console.log(a),console.log("draw:editstop")}),b.on("draw:deleted",function(){a.active=!1})}),angular.extend(a,{markers:{},paths:{}}),a.autoFillProjects=function(b){a.searchStatus=!1,a.project_docs=!1,angular.element(".angular-leaflet-map").removeClass("map-move"),a.projects=[];var c=f.autoFill(b);c.then(function(b){if(b.features){b.features=f.getSet(b.features);for(var c=0,d=b.features.length;d>c;c++)a.projects.length<5&&a.projects.push(b.features[c].attributes.PROJECTNAME+":"+b.features[c].attributes.DEVPLANID+":"+b.features[c].attributes.PROJECTID)}},function(a){console.log(a)}),scope.myrecent=a.projects},a.searchControl=function(b){console.log(b),i.addProjectCookie(b);var f=b.split(":"),h={layer:"Project Tracking",geojson:!0,actions:"query",params:{f:"json",outFields:"*",where:"PROJECTID =  '"+f[2]+"'",outSR:4326,returnGeometry:!0}},k={layer:"RPUD.PTK_DOCUMENTS",actions:"query",params:{f:"json",outFields:"*",where:"PROJECTID =  '"+f[2]+"'"}};j.pt_fs.request(h).then(function(b){console.log(b),a.project_info=b.features[0].properties,a.project_info.CREATEDON=c("date")(a.project_info.CREATEDON,"MM/dd/yyyy"),a.project_info.DEVPLAN_APPROVAL=c("date")(a.project_info.DEVPLAN_APPROVAL,"MM/dd/yyyy"),a.project_info.EDITEDON=c("date")(a.project_info.EDITEDON,"MM/dd/yyyy"),l(a.project_info),a.searchStatus=!0,m.clearLayers(),L.geoJson(b,{onEachFeature:function(a,b){m.addLayer(b)}}),e.getMap("map").then(function(a){a.fitBounds(m.getBounds()),m.addTo(a),console.log("made it")}),j.pt_fs.request(k).then(function(b){if(0!==b.features.length){angular.element(".angular-leaflet-map").addClass("map-move"),angular.element(".map-edit-container").addClass("map-edit-container-move");var c;a.project_docs=b.features.map(function(a){c=a.attributes.DOCTYPEID?a.attributes.DOCTYPEID.toLowerCase():"";var b={url:d.trustAsResourceUrl(g.documentBaseUrl+a.attributes.PROJECTID+"/"+a.attributes.PROJECTID+"-"+a.attributes.DOCTYPEID+"-"+a.attributes.DOCID+".pdf"),name:a.attributes.PROJECTID+"-"+a.attributes.DOCTYPEID+"-"+a.attributes.DOCID,resid:a.attributes.PROJECTID+"-"+a.attributes.DOCTYPEID+"-"+a.attributes.DOCID+"res",icon:"../images/"+c+".png"};return b});for(var e in a.project_docs){var f="#"+a.project_docs[e].resid;$(f).resizable()}}})})},a.list1={title:"AngularJS - Drag Me"};var s="http://mapstest.raleighnc.gov/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task/execute";a.dpi=90,a.print_format="PDF",a.exportSizes=[{size:[500,500]},{size:[700,500]},{size:[700,1e3]}],a.printFormatList=["PDF","PNG8","PNG32","JPG","GIF","EPS","SVG","SVGZ"];var t={mapOptions:{},operationalLayers:[],baseMap:[{title:"Basemap",baseMapLayers:[{url:"http://maps.raleighnc.gov/arcgis/rest/services/BaseMap/MapServer",opacity:1}]}],exportOptions:{dpi:a.dpi,outputSize:[700,500]||a.output}};e.getMap("map").then(function(b){b.on("move",function(){a.mapbounds=b.getBounds(),t.mapOptions.extent={xmin:a.mapbounds._southWest.lat,ymin:a.mapbounds._southWest.lng,xmax:a.mapbounds._northEast.lat,ymax:a.mapbounds._northEast.lng},t.operationalLayers=[],b.eachLayer(function(a){b.hasLayer(a)?t.operationalLayers.push({url:a.url}):console.log("No layers added to print")})});var c=L.control({position:"bottomright"});c.onAdd=function(){var a=L.DomUtil.create("div","info legend");return a.innerHTML='<button class="btn btn-primary btn-sm mapPrint" data-toggle="modal" data-target="#myModal">Print</button>',a},c.addTo(b)}),a.print_params={Web_Map_as_JSON:t,format:a.print_format,Layout_Template:"MAP_ONLY",f:"json"},a.$watch("print_params",function(){},!0),a.printMap=function(){b.get(s,{params:a.print_params,headers:{"Content-Type":"text/plain"}}).success(function(a){console.log(a)})}}]),angular.module("asbuiltsApp").controller("FormCtrl",["$scope","$http","$filter","StreetSearch",function(a,b,c,d){function e(b,c){for(var d in a.servers[0].test.layers)for(var e in a.servers[0].test.layers[d])if(a.servers[0].test.layers[d][e].name===b){var f=a.servers[0].test.FeatureServer+"/"+a.servers[0].test.layers[d][e].id+"/"+c;return f}}function f(a,b,c,d){for(var e in a)for(var f in b)a[e].attributes[c]===b[f].attributes[c]&&(a[e].attributes[d]=b[f].attributes[d])}function g(a){var b=[];for(var c in a)b.push(a[c].attributes.DOCID);return b.sort(function(a,b){return b-a}),b[0]}function h(b){for(var c in a.sheets)1===a.sheets[c].attributes[b]?a.sheets[c].attributes[b]="True":0===a.sheets[c].attributes[b]&&(a.sheets[c].attributes[b]="False")}a.pageControls={continueButton:!1,deleteLastRecord:!1,table:!1,noRecords:!1},a.fields=null,a.projects=null,a.formSuccess=!1,a.selections=[{name:!0,id:1},{name:!1,id:0}],a.selectionOptions={project:"--Please Select Project--",doctype:"--Please Select Document Type--",engineer:"--Please Select Engineering Firm--",tf:"--Please Select--",sheet:"--Please Select Sheet--"};var i=0;a.servers=[{test:{FeatureServer:"http://mapstest.raleighnc.gov/arcgis/rest/services/PublicUtility/ProjectTracking/FeatureServer",layers:[]}},{WAKE:{Addresses:"http://maps.raleighnc.gov/arcgis/rest/services/Addresses/MapServer/0/query"}}];var j=function(c,d,e){var f={f:"json",outFields:"*",where:"OBJECTID >"+c,orderByFields:d+" ASC",returnGeometry:!1};for(var g in a.servers[0].test.layers)for(var h in a.servers[0].test.layers[g])if(a.servers[0].test.layers[g][h].name===e){var i=a.servers[0].test.FeatureServer+"/"+a.servers[0].test.layers[g][h].id+"/query";b.get(i,{params:f,cache:!0}).success(function(b){if("RPUD.ENGINEERINGFIRM"===e&&(a.engfirms=b.features),"Project Tracking"===e){a.projects=b.features,a.projectnames=[];for(var c in a.projects)a.projectnames.push(a.projects[c].attributes.PROJECTNAME+":"+a.projects[c].attributes.DEVPLANID+":"+a.projects[c].attributes.PROJECTID)}"RPUD.PTK_DOCUMENTS"===e&&(a.fields=b.fields),"RPUD.SHEETTYPES"===e&&(a.sheetdisc=b.features),"RPUD.DOCUMENTTYPES"===e&&(a.doctypes=b.features)})}};b.get(a.servers[0].test.FeatureServer,{params:{f:"json"},cache:!0}).success(function(b){a.servers[0].test.layers.push(b.layers),a.servers[0].test.layers.push(b.tables),setTimeout(function(){j(i,"OBJECTID","RPUD.PTK_DOCUMENTS"),j(i,"PROJECTNAME","Project Tracking"),j(i,"SIMPLIFIEDNAME","RPUD.ENGINEERINGFIRM"),j(i,"SHEETTYPE","RPUD.SHEETTYPES"),j(i,"DOCUMENTTYPE","RPUD.DOCUMENTTYPES")},1e3)}),a.change=function(d){var i=d.split(":");a.form.PROJECTID=parseInt(i[2]),a.form.DEVPLANID=i[1],a.form.PROJECTNAME=i[0];var j=["SEALDATE","SEALNUMBER","ENGID","FORMERNAME","ALIAS"],k={f:"json",outFields:"*",where:"PROJECTID =  '"+i[2]+"'",orderByFields:"DOCID ASC",returnGeometry:!1},l=e("RPUD.PTK_DOCUMENTS","query");b.get(l,{params:k}).success(function(b){if(console.log(b),a.sheets=b.features,f(a.sheets,a.doctypes,"DOCTYPEID","DOCUMENTTYPE"),f(a.sheets,a.sheetdisc,"SHEETTYPEID","SHEETTYPE"),f(a.sheets,a.engfirms,"ENGID","SIMPLIFIEDNAME"),h("WATER"),h("SEWER"),h("REUSE"),h("STORM"),a.sheetFields=b.fields,0===a.sheets.length){a.pageControls.table=!1,a.pageControls.noRecords=!0;for(var d in j)a.form[j[d]]=null;a.form.DOCID=1}else{a.pageControls.table=!0,a.pageControls.noRecords=!1,a.form.DOCID=g(a.sheets)+1;
for(var d in j)a.form[j[d]]=a.sheets[0].attributes[j[d]],a.form.SEALDATE=c("date")(a.sheets[0].attributes.SEALDATE,"yyyy-MM-dd"),a.selectionOptions.engineer=a.sheets[0].attributes.SIMPLIFIEDNAME}})},a.autoFill=function(b){a.streets=d.autoFill(b)},a.nextSheet=function(){a.selectionOptions.project=a.entry.PROJECTNAME,a.pageControls.table=!0;var b=c("date")(a.lastDate,"yyyy-MM-dd");console.log(b),a.form={PROJECTNAME:a.entry.PROJECTNAME,SEALDATE:b,SEALNUMBER:a.entry.SEALNUMBER,DOCID:a.entry.DOCID+1,DEVPLANID:a.entry.DEVPLANID,JURISDICTION:a.entry.JURISDICTION,PROJECTID:a.entry.PROJECTID}},a.delete=function(){var c=e("RPUD.PTK_DOCUMENTS","deleteFeatures");b.post(c,a.postResults,{params:{f:"json",objectIds:a.postResults.objectId},headers:{"Content-Type":"text/plain"}}).success(function(b){console.log(b),a.form.DOCID===a.entry.DOCID+1&&(a.form.DOCID=a.entry.DOCID),a.sheets.pop()}),0===a.sheets.length&&(a.pageControls.table=!1,a.pageControls.noRecords=!0,a.sheets=[])},a.submit=function(c){if(-1!==c.SEALDATE.indexOf("-")){a.lastDate=c.SEALDATE;var d=c.SEALDATE.split("-");a.lastDate=d[1]+"/"+d[2]+"/"+d[0]}var f={PROJECTNAME:c.PROJECTNAME,SEALDATE:a.lastDate,SEALNUMBER:c.SEALNUMBER,DOCTYPEID:c.DOCTYPEID.attributes.DOCTYPEID,DOCID:c.DOCID,ENGID:c.ENGID.attributes.ENGID,WATER:c.WATER.id,SEWER:c.SEWER.id,REUSE:c.REUSE.id,STORM:c.STORM.id,FORMERNAME:c.FORMERNAME||null,ALIAS:c.ALIAS||null,DEVPLANID:c.DEVPLANID,STREET_1:c.STREET_1||null,STREET_2:c.STREET_2||null,STREET_3:c.STREET_3||null,STREET_4:c.STREET_4||null,NOTES:c.NOTES||null,TAGS:c.TAGS||null,PROJECTID:c.PROJECTID,SHEETTYPEID:c.SHEETTYPEID.attributes.SHEETTYPEID};a.pageControls.table=!1,a.entry=f,a.entry.SIMPLIFIEDNAME=c.ENGID.attributes.SIMPLIFIEDNAME;var g=[{attributes:f}],h=angular.toJson(g),i={params:{f:"json",features:h},headers:{"Content-Type":"text/plain"}},j=e("RPUD.PTK_DOCUMENTS","addFeatures");b.post(j,f,i).success(function(b){console.log(b),a.form.$setPristine(),a.form={},a.postResults=b.addResults[0],a.sheets.push({attributes:f})}),a.pageControls.deleteLastRecord=!0,a.pageControls.continueButton=!0},a.over,a.tableEdits={edit:{cell:function(c,d){var e={};e.OBJECTID=c,e[d]=a.table[d];var f=[{attributes:e}],g=angular.toJson(f),h={params:{f:"json",features:g},headers:{"Content-Type":"text/plain"}};b.post(a.servers[0].test.FeatureServer+"/"+a.servers[0].test.tables[0].id+"/updateFeatures",e,h).success(function(a){console.log(a)})}},"delete":{row:function(c){var d=e("RPUD.PTK_DOCUMENTS","deleteFeatures");b.post(d,a.postResults,{params:{f:"json",objectIds:c},headers:{"Content-Type":"text/plain"}}).success(function(b){console.log(b);for(var d in a.sheets)a.sheets[d].attributes.OBJECTID===c&&(console.log(d),a.sheets.splice(d,1))}),0===a.sheets.length&&(a.pageControls.noRecords=!0,a.pageControls.table=!1)}}}}]),angular.module("asbuiltsApp").controller("DocCtrl",["$scope","$routeParams","$http","$sce",function(a,b,c,d){function e(a){for(var b in a[0].attributes)a[0].attributes[b]?a[0].attributes[b]:delete a[0].attributes[b]}function f(a,b,c,d){for(var e in a)for(var f in b)a[e].attributes[c]===b[f].attributes[c]&&(console.log("Join Fields Match"),a[e].attributes[d]=b[f].attributes[d],delete a[e].attributes[c])}var g="http://gis.raleighnc.gov/asbuilts/PROJECT_TRACKING/";a.documentid=b.documentid,a.doc=a.documentid.split("-"),a.url=d.trustAsResourceUrl(g+a.doc[0]+"/"+a.documentid+".pdf");var h={f:"json",outFields:"*",where:"PROJECTID = "+a.doc[0]+" AND DOCTYPEID = '"+a.doc[1]+"' AND DOCID = "+a.doc[2]},i={f:"json",outFields:"*",where:"OBJECTID > 0"},j="http://mapstest.raleighnc.gov/arcgis/rest/services/PublicUtility/ProjectTracking/FeatureServer/5/query";c.get(j,{params:h,cache:!0}).success(function(b){console.log(b),a.documentDetails=b.features,e(a.documentDetails);var d="http://mapstest.raleighnc.gov/arcgis/rest/services/PublicUtility/ProjectTracking/FeatureServer/9/query";c.get(d,{params:i,cache:!0}).success(function(b){console.log(b),a.doctypes=b.features,f(a.documentDetails,a.doctypes,"DOCTYPEID","DOCUMENTTYPE")})}),a.$watch("documentDetails",function(){console.log(a.documentDetails)},!0)}]),angular.module("asbuiltsApp").controller("uploadCtrl",["$scope","FileUploader",function(a,b){a.loadStatus={addFile:{status:!1,message:"Please check fields file name incorrect"}},a.uploadSuccess="",a.uploader=a.uploader=new b({url:"http://localhost:8000/upload",removeAfterUpload:!0}),a.uploader.filters.push({name:"checkName",fn:function(b,c){var d=/[0-9]{6}-[A-Z]{2}-[0-9]*/;return d.test(c.formData.newName)?(console.log("Passed RegEx"),c.formData.newName):(a.loadStatus.addFile.message="Invalid File Name: "+c.formData.newName,console.log("Failed RegEx: "+c.formData.newName),!1)}}),a.uploader.filters.push({name:"checkFileType",fn:function(b){var c="|"+b.type.slice(b.type.lastIndexOf("/")+1)+"|";return a.loadStatus.addFile.message="Invalid File Type: "+c+", please select a pdf.",-1!=="|pdf|PDF".indexOf(c)}}),a.uploader.onWhenAddingFileFailed=function(){a.uploadSuccess="",a.loadStatus.addFile.status=!0},a.uploader.onAfterAddingFile=function(a){console.info("onAfterAddingFile",a)},a.uploader.onAfterAddingAll=function(a){console.info("onAfterAddingAll",a)},a.uploader.onBeforeUploadItem=function(a){return a.file.name=a.formData.newName+".pdf",console.log(a),a},a.uploader.onProgressItem=function(a,b){console.info("onProgressItem",a,b)},a.uploader.onProgressAll=function(a){console.info("onProgressAll",a)},a.uploader.onSuccessItem=function(b,c,d,e){console.info("onSuccessItem",b,c,d,e),a.uploadSuccess=b.isSuccess&&"Upload Successful"},a.uploader.onErrorItem=function(a,b,c,d){console.info("onErrorItem",a,b,c,d)},a.uploader.onCancelItem=function(a,b,c,d){console.info("onCancelItem",a,b,c,d)},a.uploader.onCompleteItem=function(b,c,d,e){console.info("onCompleteItem",b,c,d,e),a.uploadSuccess=b.isSuccess&&"Upload Successful"}}]),angular.module("asbuiltsApp").controller("addDocCtrl",["$scope","CookieService","serverFactory","projectSearch","$rootScope",function(a,b,c,d,e){var f=e;a.project={},a.autoFillProjects=function(b){a.searchStatus=!1,a.project_docs=!1,a.projects=[];var c=d.autoFill(b);c.then(function(b){b.features=d.getSet(b.features),0===b.features.length&&a.projects.push("Sorry Project Not Found...");for(var c=0,e=b.features.length;e>c;c++)a.projects.length<5&&a.projects.push(b.features[c].attributes.PROJECTNAME+":"+b.features[c].attributes.DEVPLANID+":"+b.features[c].attributes.PROJECTID)},function(a){console.log(a)}),f.myrecent=a.projects},a.searchControl=function(d){if("Sorry Project Not Found..."!==d){b.addProjectCookie(d);var e={layer:"RPUD.PTK_DOCUMENTS",actions:"query",params:{f:"json",where:"PROJECTID = "+d.split(":")[2],outFields:"*",orderByFields:"DOCID ASC",returnGeometry:!1}};c.pt_fs.request(e).then(function(b){a.project=b.features.length?b.features:[{"new":!0,attributes:{PROJECTID:d.split(":")[2],PROJECTNAME:d.split(":")[0]}}],a.searchStatus=!0,a.project_docs=!0})}}}]),angular.module("asbuiltsApp").controller("projectCtrl",["$scope","$cookieStore","$rootScope","$routeParams","Ags","leafletData",function(a,b,c,d,e,f){function g(a){for(var b in a)"Null"===a[b]?delete a[b]:a[b];return console.log(a),a}var h=new e({host:"mapstest.raleighnc.gov"});a.projectid=d.projectid;var i=h.setService({folder:"PublicUtility",service:"ProjectTracking",server:"MapServer"}),j={params:{f:"json",searchText:a.projectid,searchFields:"PROJECTID",layers:"Project Tracking, RPUD.PTK_DOCUMENTS",sr:4326},actions:"find",geojson:!0},k={layer:"RPUD.PTK_DOCUMENTS",actions:"query",params:{f:"json",outFields:"*",where:"PROJECTID =  '"+a.projectid+"'"}};i.request(k).then(function(b){console.log(b),a.projectDocuments=b.features}),f.getMap("project-map").then(function(a){L.tileLayer("https://{s}.tiles.mapbox.com/v3/examples.3hqcl3di/{z}/{x}/{y}.png").addTo(a)}),i.request(j).then(function(b){console.log(b),a.projectInfo=b.features[0].properties,a.projectInfo=g(a.projectInfo),f.getMap("project-map").then(function(a){L.geoJson(b,{onEachFeature:function(b,c){a.fitBounds(c.getBounds())}}).addTo(a)})},function(a){console.log(a)})}]);